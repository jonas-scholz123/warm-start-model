defaults:
  - base_cfg
  - _self_
  - data: mnist
  - mode: ???
  - override hydra/hydra_logging: disabled
  - override hydra/job_logging: disabled

hydra:
  mode: RUN
  output_subdir: null
  run:
    dir: .

paths:
  root: ${runtime.root}
  data: ${runtime.root}/_data
  raw_data: ${runtime.root}/_data/_raw
  output: ${runtime.root}/_output/mnist_diffusion
  weights: ${runtime.root}/_weights

execution:
  epochs: 8
  seed: 42
  start_from: LATEST
  start_weights: null

output:
  save_checkpoints: true
  out_dir: ${runtime.root}/_output
  wandb_project: cdnp
  log_gradients: false
  gradient_log_freq: 100
  use_tqdm: true
  log_level: INFO
  plotter:
   _target_: cdnp.plot.plotter.Plotter
   _partial_: true
   device: ${runtime.device}
   num_samples: 4
   num_classes: ${data.num_classes}
   num_channels: ${data.in_channels}
   sidelength: ${data.sidelength}

rng:
  generator:
    _target_: torch.Generator
    device: ${runtime.device}

  cpu_generator:
    _target_: torch.Generator
    device: cpu

loss:
  _target_: torch.nn.NLLLoss

model:
  _target_: cdnp.model.ddpm.DDPM
  noise_scheduler:
    _target_: diffusers.DDPMScheduler
    num_train_timesteps: 1000
    beta_schedule: "squaredcos_cap_v2"
  device: ${runtime.device}
  model:
    _target_: diffusers.UNet2DModel
    sample_size: ${data.sidelength}
    in_channels: ${data.in_channels}
    out_channels: ${data.in_channels}
    layers_per_block: 2
    block_out_channels: [32, 64, 64]
    down_block_types:
      - DownBlock2D
      - AttnDownBlock2D
      - AttnDownBlock2D
    up_block_types:
      - AttnUpBlock2D
      - AttnUpBlock2D
      - UpBlock2D
    num_class_embeds: ${data.num_classes}
  loss_fn:
    _target_: torch.nn.MSELoss

optimizer:
  _target_: torch.optim.Adam
  _partial_: true
  lr: 1e-3

scheduler:
  _target_: torch.optim.lr_scheduler.LinearLR
  _partial_: true
  start_factor: 1.0
  end_factor: 0.0
  total_iters: ${execution.epochs}

data:
  dataset:
    paths: ${paths}
    val_fraction: 0.1
  cache: false
  trainloader:
    _target_: torch.utils.data.DataLoader
    _partial_: true
    batch_size: 128
    shuffle: true
    num_workers: 0
    multiprocessing_context: null
  testloader:
    _target_: torch.utils.data.DataLoader
    _partial_: true
    batch_size: 1000
    shuffle: false
    num_workers: 0
    multiprocessing_context: null
